-- Criar as novas tabelas
CREATE TABLE ALUNOS (
ID_ALUNO INT PRIMARY KEY,
NOME_ALUNO VARCHAR(150),
EMAIL VARCHAR(100),
DATA_INGRESSO DATE);

CREATE TABLE CURSOS (
ID_CURSO INT PRIMARY KEY,
NOME_CURSO VARCHAR(100),
DEPARTAMENTO VARCHAR(100),
CREDITOS INT);

CREATE TABLE MATRICULAS (
ID_MATRICULA INT PRIMARY KEY,
ID_ALUNO INT,
ID_CURSO INT,
NOTA_FINAL DECIMAL(4, 2),
FOREIGN KEY (ID_ALUNO) REFERENCES ALUNOS(ID_ALUNO),
FOREIGN KEY (ID_CURSO) REFERENCES CURSOS(ID_CURSO));

-- Inserir dados de exemplo
INSERT INTO ALUNOS (ID_ALUNO, NOME_ALUNO, EMAIL, DATA_INGRESSO) VALUES
(1, 'Lucas Martins', 'lucas.m@email.com', '2023-02-01'),
(2, 'Sofia Pereira', 'sofia.p@email.com', '2023-02-01'),
(3, 'Mariana Costa', 'mariana.c@email.com', '2022-08-01'),
(4, 'Rafael Santos', 'rafael.s@email.com', '2024-02-01');

-- Aluno novo, sem matrícula
INSERT INTO CURSOS (ID_CURSO, NOME_CURSO, DEPARTAMENTO, CREDITOS) VALUES
(101, 'Algoritmos e Programação', 'Ciência da Computação', 4),
(102, 'Cálculo I', 'Matemática', 6),
(103, 'Administração de Empresas', 'Gestão', 4),
(104, 'Estrutura de Dados', 'Ciência da Computação', 6);

INSERT INTO MATRICULAS (ID_MATRICULA, ID_ALUNO, ID_CURSO, NOTA_FINAL) VALUES
(1, 1, 101, 8.5),
(2, 1, 102, 7.0),
(3, 2, 101, 9.0),
(4, 2, 104, 8.8),
(5, 3, 103, 6.5);

----Parte 1-----

-- 1. Consulta Geral: Selecione todas as informações da tabela ALUNOS
SELECT * FROM ALUNOS;

--2. Consulta Específica: Crie um relatório que mostre apenas o nome e o departamento de todos os cursos, com os títulos das colunas sendo "Curso" e "Departamento Responsável".
SELECT 
    NOME_CURSO AS "Curso",
    DEPARTAMENTO AS "Departamento Responsável"
FROM CURSOS;

--3. Filtro Numérico: Liste o nome e os créditos de todos os cursos que valem mais de 4 créditos.
SELECT 
    NOME_CURSO,
    CREDITOS
FROM CURSOS
WHERE CREDITOS > 4;

--4. Filtro de Data: Mostre o nome e o email dos alunos que ingressaram a partir do início de 2023 (ou seja, DATA_INGRESSO maior ou igual a '2023-01-01').
SELECT 
    NOME_ALUNO,
    EMAIL
FROM ALUNOS
WHERE DATA_INGRESSO >= '2023-01-01';

--5. Filtro com AND e Ordenação: Liste o nome e a nota final de todas as matrículas do aluno de ID_ALUNO = 1 E cuja NOTA_FINAL foi maior ou igual a 7.0. 
-- Ordene o resultado pela nota, da maior para a menor.
SELECT 
    NOTA_FINAL
FROM MATRICULAS
WHERE ID_ALUNO = 1 
  AND NOTA_FINAL >= 7.0
ORDER BY NOTA_FINAL DESC;

SELECT 
	A.NOME_ALUNO AS 'Nome do Aluno',
	M.NOTA_FINAL AS 'Nota Final'
FROM MATRICULAS	M
JOIN ALUNOS A ON M.ID_ALUNO = A.ID_ALUNO 
WHERE M.ID_ALUNO = 1 AND M.NOTA_FINAL >= 7.0
ORDER BY M.NOTA_FINAL DESC;

----Parte 2----
--1. Valores Únicos: Qual é a lista de departamentos únicos que oferecem cursos na universidade?
SELECT DISTINCT DEPARTAMENTO
FROM CURSOS;

--2. Lógica Condicional: Crie um relatório de matrículas que mostre o ID_MATRICULA e uma nova coluna chamada STATUS . O status deve ser 'Aprovado' 
--se a NOTA_FINAL for maior ou igual a 7.0, e 'Reprovado' caso contrário.
SELECT MATRICULAS.ID_ALUNO AS 'ID Aluno',
	CASE WHEN MATRICULAS.NOTA_FINAL >= '7.0'
	     THEN 'Aprovado'
	     ELSE 'Reprovado'
	END AS 'Status'
FROM MATRICULAS;

SELECT 
    ID_MATRICULA,
    CASE 
        WHEN NOTA_FINAL >= 7.0 THEN 'Aprovado'
        ELSE 'Reprovado'
    END AS STATUS
FROM MATRICULAS;

--3. Ordenação e Limite: Qual é o curso com o maior número de créditos? O resultado deve mostrar apenas o nome do curso e seus créditos.
SELECT 
    NOME_CURSO,
    CREDITOS
FROM CURSOS
ORDER BY CREDITOS DESC
LIMIT 1;

SELECT 
	c.NOME_CURSO AS 'Curso',
	c.CREDITOS  AS 'Créditos'
FROM  CURSOS c
ORDER BY CREDITOS DESC 
LIMIT 1;

----Parte 3----
--1. Contagem e Média: Calcule o número total de matrículas e a média geral de todas as notas finais.
SELECT 
    COUNT(ID_MATRICULA) AS Total_Matriculas,
    AVG(NOTA_FINAL) AS Media_Geral
FROM MATRICULAS;

--2. Agrupamento: Crie um relatório que mostre quantos cursos são oferecidos por departamento.
SELECT 
	DEPARTAMENTO AS 'Departamento',
	COUNT(*) AS 'Qtde de Cursos'
FROM CURSOS
GROUP BY DEPARTAMENTO;

--3. Filtro de Grupo: Com base na consulta anterior, mostre apenas os departamentos que oferecem mais de um curso.
SELECT 
	DEPARTAMENTO AS 'Departamento',
	COUNT(*) AS 'Qtde de Cursos'
FROM CURSOS
GROUP BY DEPARTAMENTO
HAVING COUNT(*) >1;

----Parte 4----
--1. Relatório de Desempenho: Crie uma consulta que mostre o nome do aluno, o nome do curso em que ele está matriculado e a sua nota final.
--(Dica: Você precisará de dois JOIN s)
SELECT 
    A.NOME_ALUNO,
    C.NOME_CURSO,
    M.NOTA_FINAL
FROM MATRICULAS M
JOIN ALUNOS A ON M.ID_ALUNO = A.ID_ALUNO
JOIN CURSOS C ON M.ID_CURSO = C.ID_CURSO;

SELECT
   ALUNOS.NOME_ALUNO AS NOME_ALUNO,
   CURSOS.NOME_CURSO  AS NOME_CURSO,
   MATRICULAS.NOTA_FINAL
FROM MATRICULAS
JOIN ALUNOS ON MATRICULAS.ID_ALUNO = ALUNOS.ID_ALUNO
JOIN CURSOS ON MATRICULAS.ID_CURSO = CURSOS.ID_CURSO
ORDER BY ALUNOS.NOME_ALUNO;

--2. Busca por Alunos sem Matrícula: Qual aluno está cadastrado na universidade mas ainda não se matriculou em nenhum curso? 
--A consulta deve retornar apenas o nome deste aluno. (Dica: LEFT JOIN com um filtro
--(WHERE ... IS NULL ).
SELECT a.NOME_ALUNO AS 'Aluno sem Matrícula'
FROM ALUNOS a 
LEFT JOIN MATRICULAS m ON a.ID_ALUNO = m.ID_ALUNO
WHERE m.ID_MATRICULA IS NULL;

----Desafio Final----
SELECT
  a.NOME_ALUNO,
  ROUND(AVG(m.NOTA_FINAL), 2) AS MEDIA_NOTAS
FROM
  ALUNOS AS a
JOIN
  MATRICULAS AS m
  ON a.ID_ALUNO = m.ID_ALUNO
GROUP BY
  a.NOME_ALUNO
ORDER BY
  MEDIA_NOTAS DESC
LIMIT 1;

SELECT 
    A.NOME_ALUNO,
    ROUND(AVG(M.NOTA_FINAL), 2) AS MEDIA
FROM ALUNOS A
JOIN MATRICULAS M ON A.ID_ALUNO = M.ID_ALUNO
GROUP BY A.NOME_ALUNO
ORDER BY MEDIA DESC
LIMIT 1;
